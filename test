SELECT wtch1.userid,
  SUM(wtch1.unique_views)        AS unique_views,
  SUM(wtch1.trailer_views)       AS trailer_views,
  SUM(wtch2.views_after_trailer) AS views_after_trailer
FROM
  (select 
    trailer_views.userid,
    COUNT(DISTINCT(CASE WHEN vod_catalog.contentsubtype != 'TRAILER' or vod_catalog.contentsubtype is null THEN  trailer_contentid END )) AS unique_views,
    SUM(CASE WHEN vod_catalog.contentsubtype = 'TRAILER' THEN 1 END) AS trailer_views
    FROM (SELECT userid,
      contentid as trailer_contentid
  FROM watching
  WHERE partition_date='${hiveconf:ENDDATE}'
  AND customerid     != 'GUEST'
  AND download       is null) as trailer_views --exclude download events
  LEFT OUTER JOIN vod_catalog  
  ON  trailer_views.trailer_contentid = vod_catalog.contentid
  GROUP BY userid
  ) wtch1
LEFT OUTER JOIN
  (SELECT 
    trailer_views.userid, --views_after_trailer.main_contentid   Konstantin was comment this row
    COUNT(1) AS views_after_trailer_count,
    count(distinct(IF(array_contains(split(CHILDCONTENTIDS,'[\\|]'), trailer_contentid) = True, non_trailer.timestamp, null))) AS views_after_trailer
  FROM
  (
    SELECT 
      views_after_trailer.* 
    FROM
      (SELECT userid,
        sessionid,
        contentid as trailer_contentid,
        TIMESTAMP
        FROM watching
        WHERE partition_date= '${hiveconf:ENDDATE}' -- specify date
        AND customerid      != 'GUEST'
      ) as views_after_trailer
      INNER JOIN vod_catalog  
      ON  views_after_trailer.trailer_contentid = vod_catalog.contentid
      WHERE vod_catalog.CONTENTSUBTYPE = 'TRAILER'
  ) AS trailer_views
  LEFT OUTER JOIN
  (SELECT 
    views_after_trailer.*,
    CHILDCONTENTIDS 
  FROM
  (
    SELECT userid,
    sessionid,
    contentid as main_contentid,
    TIMESTAMP
    FROM watching
    WHERE partition_date= '${hiveconf:ENDDATE}'
    AND download is null
  ) views_after_trailer
  LEFT OUTER JOIN vod_catalog  
  ON  views_after_trailer.main_contentid = vod_catalog.contentid
  WHERE vod_catalog.CONTENTSUBTYPE != 'TRAILER'
  ) AS non_trailer
  ON trailer_views.userid      = non_trailer.userid
  AND trailer_views.sessionid  = non_trailer.sessionid
  WHERE trailer_views.timestamp < non_trailer.timestamp
  GROUP BY trailer_views.userid 
  ) wtch2 ON wtch1.userid = wtch2.userid
GROUP BY wtch1.userid;
